<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP Reporter 管理面板</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* 为禁用的按钮添加更明显的样式 */
        .action-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
            opacity: 0.7;
        }
        /* 动态flash消息的样式 */
        .flash-dynamic-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            width: 320px;
        }
        .flash-dynamic {
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            border-radius: 0.25rem;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }
        .flash-dynamic.success {
            color: #0f5132;
            background-color: #d1e7dd;
            border-color: #badbcc;
        }
        .flash-dynamic.error {
            color: #842029;
            background-color: #f8d7da;
            border-color: #f5c2c7;
        }
        /* 调整表单间距和编号输入框宽度 */
        .remark-form {
            margin-top: 0.25rem !important;
            margin-bottom: 0.25rem !important;
        }
        .remark-input.id-input {
            width: 70px;
            flex-grow: 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>IP Reporter 管理面板</h1>

        <!-- 用于Flask后端在页面重载时显示的消息 -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-container">
                {% for category, message in messages %}
                    <div class="flash flash-{{ category }}">{{ message }}</div>
                {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        
        <!-- 用于JavaScript动态显示AJAX结果的容器 -->
        <div id="flash-container-dynamic" class="flash-dynamic-container"></div>

        <div class="filter-container">
            <button class="filter-btn active" data-region="all">全部地区</button>
            {% for region in regions %}
                <button class="filter-btn" data-region="{{ region }}">{{ region }}</button>
            {% endfor %}
            <span style="margin-left: 20px;">排序:</span>
            <a href="{{ url_for('admin_dashboard', sort_by='id') }}" class="filter-btn {% if current_sort == 'id' %}active{% endif %}">按编号</a>
            <a href="{{ url_for('admin_dashboard', sort_by='time') }}" class="filter-btn {% if current_sort == 'time' %}active{% endif %}">按时间</a>
            <a href="{{ url_for('admin_dashboard', sort_by='ip') }}" class="filter-btn {% if current_sort == 'ip' %}active{% endif %}">按IP</a>
        </div>

        <table id="clients-table">
            <thead>
                <tr>
                    <th>机器IP / 备注 / 编号</th>
                    <th>地区 / 注册地</th>
                    <th>ASN / 组织</th>
                    <th>风险评分</th>
                    <th>流媒体解锁状态</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for client in clients %}
                <tr data-client-region="{{ client.display_region }}">
                    <td>
                        <strong>{{ client.ip }}</strong>
                        <!-- 备注表单 -->
                        <form action="{{ url_for('update_remark') }}" method="post" class="remark-form">
                            <input type="hidden" name="ip" value="{{ client.ip }}">
                            <input type="text" name="remark" value="{{ client.remark or '' }}" placeholder="添加备注" class="remark-input">
                            <button type="submit" class="action-btn btn-save">保存</button>
                        </form>
                        <!-- 机器编号表单 -->
                        <form action="{{ url_for('update_machine_id') }}" method="post" class="remark-form">
                            <input type="hidden" name="ip" value="{{ client.ip }}">
                            <input type="number" name="machine_id" value="{{ client.machine_id if client.machine_id is not none else '' }}" placeholder="编号" class="remark-input id-input" min="0">
                            <button type="submit" class="action-btn btn-save">保存</button>
                        </form>
                    </td>
                    <td>
                        <strong>{{ client.display_region }}</strong>
                        {% set report = client.report_data %}{% if not client.is_error and report.Info and report.Info[0] %}{% set info = report.Info[0] %}
                        <span class="sub-info">注册: [{{ info.RegisteredRegion.Code or '?' }}] {{ info.RegisteredRegion.Name or 'N/A' }}</span>
                        <span class="sub-info">洲: {{ info.Continent.Name or 'N/A' }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if client.is_error %}
                            <strong style="color: red;">执行失败</strong>
                            {% if report.Info and report.Info[0] %}<span class="sub-info ellipsis" title="{{ report.Info[0].Organization }}">{{ report.Info[0].Organization }}</span>{% endif %}
                            {% if report.ErrorLog and report.ErrorLog.stdout %}<details style="margin-top: 8px; font-size: 0.8em; cursor: pointer;"><summary>显示日志</summary><pre style="white-space: pre-wrap; background: #eee; padding: 5px; border-radius: 4px; max-height: 200px; overflow-y: auto; margin-top: 5px;">{{ report.ErrorLog.stdout }}\n{{ report.ErrorLog.stderr }}</pre></details>{% endif %}
                        {% elif report.Info and report.Info[0] %}
                            <strong>AS{{ report.Info[0].ASN or 'N/A' }}</strong>
                            <span class="sub-info ellipsis" title="{{ report.Info[0].Organization or 'N/A' }}">{{ report.Info[0].Organization or 'N/A' }}</span>
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td>
                        {% if not client.is_error and report.Score and report.Score[0] %}{% set scores = report.Score[0] %}<div class="risk-grid">
                            <div class="risk-item">Scamalytics: <strong>{{ scores.SCAMALYTICS if scores.SCAMALYTICS is not none else 'N/A' }}</strong></div>
                            <div class="risk-item">ipapi: <strong>{{ scores.ipapi if scores.ipapi is not none else 'N/A' }}</strong></div>
                            <div class="risk-item">AbuseIPDB: <strong>{{ scores.AbuseIPDB if scores.AbuseIPDB is not none else 'N/A' }}</strong></div>
                            <div class="risk-item">IPQS: <strong>{{ scores.IPQS if scores.IPQS is not none else 'N/A' }}</strong></div>
                            <div class="risk-item">Cloudflare: <strong>{{ scores.Cloudflare if scores.Cloudflare is not none else 'N/A' }}</strong></div>
                        </div>{% else %}N/A{% endif %}
                    </td>
                    <td>
                        {% if not client.is_error and report.Media and report.Media[0] %}{% set media = report.Media[0] %}{% set services = {'TikTok': 'TikTok', 'DisneyPlus': 'Disney+', 'Netflix': 'Netflix', 'Youtube': 'Youtube', 'AmazonPrimeVideo': 'PrimeVideo', 'Spotify': 'Spotify', 'ChatGPT': 'ChatGPT'} %}<div class="media-grid">{% for service_key, display_name in services.items() %}{% if media[service_key] %}{% set service = media[service_key] %}<div class="media-item {% if service.Status == '解锁' %}status-yes{% elif service.Status in ['仅自制', 'DNS'] %}status-org{% else %}status-no{% endif %}"><span>{{ display_name }}: <strong>{{ service.Region or 'N/A' }}</strong></span><span class="details"> ({{ service.Status or '?' }}{% if service.Type and service.Type != '' %}/{{ service.Type }}{% endif %})</span></div>{% endif %}{% endfor %}</div>{% else %}N/A{% endif %}
                    </td>
                    <td>
                        <span class="last-report-time">{{ client.last_report_time }}</span>
                        <form class="retest-form" action="{{ url_for('trigger_retest', ip=client.ip) }}" method="post" style="margin-bottom: 5px;">
                            <button type="submit" class="action-btn retest-button" data-ip="{{ client.ip }}">马上重测</button>
                        </form>
                        <form action="{{ url_for('delete_client', ip=client.ip) }}" method="post" onsubmit="return confirm('您确定要删除这台机器的记录吗？');">
                            <button type="submit" class="action-btn btn-delete">删除记录</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        // IIFE (立即调用函数表达式) 来封装所有逻辑，避免污染全局作用域
        (function() {
            // 全局常量
            const COOLDOWN_SECONDS = 160;

            // DOM加载完成后执行初始化
            document.addEventListener('DOMContentLoaded', function() {
                initializeRetestButtons();
                initializeRegionFilters();
            });

            /**
             * 功能1：初始化所有“马上重测”按钮的逻辑
             */
            function initializeRetestButtons() {
                const retestForms = document.querySelectorAll('.retest-form');
                
                retestForms.forEach(form => {
                    form.addEventListener('submit', function(event) {
                        event.preventDefault(); // 核心：阻止表单的默认同步提交行为
                        
                        const button = this.querySelector('.retest-button');
                        const ip = button.dataset.ip;

                        startCooldown(ip, button);

                        fetch(this.action, {
                            method: 'POST',
                            headers: { 'X-Requested-With': 'XMLHttpRequest' }
                        })
                        .then(handleFetchResponse)
                        .then(data => {
                            showDynamicFlash(data.message || `客户端 ${ip} 的任务已成功完成。`, 'success');
                            setTimeout(() => window.location.reload(), 2000);
                        })
                        .catch(error => {
                            showDynamicFlash(error.message || `连接或处理客户端 ${ip} 时发生错误。`, 'error');
                        });
                    });
                });

                // 页面加载时，恢复所有按钮的冷却状态
                document.querySelectorAll('.retest-button').forEach(button => {
                    const ip = button.dataset.ip;
                    const storageKey = 'retest_cooldown_' + ip;
                    const startTime = localStorage.getItem(storageKey);

                    if (startTime) {
                        const elapsedSeconds = (Date.now() - parseInt(startTime)) / 1000;
                        const remaining = COOLDOWN_SECONDS - elapsedSeconds;

                        if (remaining > 0) {
                            startCooldown(ip, button, Math.ceil(remaining));
                        } else {
                            localStorage.removeItem(storageKey);
                        }
                    }
                });
            }

            /**
             * 功能2：初始化所有地区过滤按钮的逻辑
             */
            function initializeRegionFilters() {
                const filterButtons = document.querySelectorAll('.filter-container .filter-btn[data-region]');
                const clientRows = document.querySelectorAll('#clients-table tbody tr[data-client-region]');

                filterButtons.forEach(button => {
                    button.addEventListener('click', function(event) {
                        event.preventDefault();
                        const selectedRegion = this.dataset.region;

                        filterButtons.forEach(btn => btn.classList.remove('active'));
                        this.classList.add('active');

                        clientRows.forEach(row => {
                            row.style.display = (selectedRegion === 'all' || row.dataset.clientRegion === selectedRegion) ? '' : 'none';
                        });
                    });
                });
            }

            /**
             * 辅助函数：启动按钮的冷却和倒计时显示
             * @param {string} ip - 客户端IP
             * @param {HTMLElement} button - 按钮元素
             * @param {number} [startSeconds=COOLDOWN_SECONDS] - 可选的起始倒计时秒数
             */
            function startCooldown(ip, button, startSeconds = COOLDOWN_SECONDS) {
                const storageKey = 'retest_cooldown_' + ip;
                if (startSeconds === COOLDOWN_SECONDS) {
                    localStorage.setItem(storageKey, Date.now());
                }
                
                button.disabled = true;
                let remainingSeconds = startSeconds;

                const updateButtonText = () => {
                    button.textContent = `重测中... (${remainingSeconds}s)`;
                };
                
                updateButtonText();

                const intervalId = setInterval(() => {
                    remainingSeconds--;
                    if (remainingSeconds > 0) {
                        updateButtonText();
                    } else {
                        clearInterval(intervalId);
                        button.disabled = false;
                        button.textContent = '马上重测';
                        localStorage.removeItem(storageKey);
                    }
                }, 1000);
            }

            /**
             * 辅助函数：处理fetch请求的响应
             */
            function handleFetchResponse(response) {
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(err));
                }
                return response.json();
            }

            /**
             * 辅助函数：显示动态的flash消息
             */
            function showDynamicFlash(message, category) {
                const container = document.getElementById('flash-container-dynamic');
                const flashDiv = document.createElement('div');
                flashDiv.className = `flash-dynamic ${category}`;
                flashDiv.textContent = message;
                container.prepend(flashDiv);
                
                setTimeout(() => {
                    flashDiv.style.opacity = '0';
                    setTimeout(() => flashDiv.remove(), 500);
                }, 5000);
            }

        })();
    </script>
</body>
</html>
